/**
 * talqsInteraction v1.0.0
 * (c) 2017 JinJun He
 * @license MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.TalqsInteraction=e()}(this,function(){"use strict";var t=function(){var t=function(){this._cache={}},e={cache:{}};return e.cache.get=function(){return this._cache},t.prototype.set=function(t,e){this._cache[t]=e},t.prototype.get=function(t){var e=this,n=[];for(var a in e._cache){var i=e._cache[a];if(t){if(a===t){n.push(i);break}i.rootId===t&&n.push(i)}else n.push(i)}return n.length?n:void 0},t.prototype.remove=function(t){delete this._cache[t]},Object.defineProperties(t.prototype,e),new t}(),e="TALQS_INTERACTION",n={INPUT:e+"_INPUT",CHANGE:e+"_CHANGE"},a=function(t){var e=new Event(n.INPUT);e.data=t,document.dispatchEvent(e)},i={type:"data-talqs-type",queId:"data-que-id",logicType:"data-logic-type",autoLayout:"data-auto-layout",optionGroup:"data-option-group",optionItem:"data-option-item",blankItem:"data-blank-item",inputid:"data-inputid",rootId:"data-talqs-root"},o=(function(e){var o="choice",s="1.0.0",r="talqs.choice",l="."+r,u=".data-api",c={CLICK_DATA_API:"click"+l+u},d={CHOICE_ITEM:"["+i.optionItem+"]",CHOICE_GROUP:"["+i.optionGroup+"]",CHOICE_CONTAINER:"["+i.type+'="choice"]',ROOT_CONTAINER:"["+i.rootId+"]",CHILD_ITEM:"["+i.type+"]"},p={QUE_ID:i.queId,LOGIC_TYPE:i.logicType,CHOICE_ITEM:i.optionItem,CHOICE_GROUP:i.optionGroup,ROOT_ID:i.rootId},I={ACTIVE:"active"},_=function(t,e,n,a,i){this._element=n,this._selected=a||[],this._config=i,this._queId=t,this._rootId=e},h={VERSION:{}};h.VERSION.get=function(){return s},_.prototype._updateClassState=function(t,n){var a=e(t).children().toArray();a&&a.forEach(function(t){var a=t.getAttribute(p.CHOICE_ITEM),i=a===n;Array.isArray(n)&&(i=!(n.indexOf(a)<0)),e(t).toggleClass(I.ACTIVE,i)})},_.prototype._updateStyleState=function(t){var n=this,a=e(this._element).find(d.CHOICE_GROUP).toArray();this._config.clozeChoice&&void 0!==t?this._updateClassState(e(a[t]),this._selected[t]):a.forEach(function(t,a){var i=n._config.clozeChoice?n._selected[a]:n._selected;n._updateClassState(e(t),i)})},_.prototype.updateSelectedState=function(e,n){if(n=parseInt(n,10),this._config.clozeChoice)this._selected[n]=this._selected[n]===e?"":e;else{var i=this._selected.indexOf(e);if(this._config.multipleChoice)i<0?this._selected.push(e):this._selected.splice(i,1);else{if(i!==-1)return;this._selected=[e]}this._selected.sort()}this._updateStyleState(n);var s={rootId:this._rootId,queId:this._queId,data:this._selected.length?this._selected:null,multiple:this._config.multipleChoice,type:o};s.data?t.set(this._queId,s):t.remove(this._queId),a(s)},_.prototype.fillDataIntoComponent=function(t){this._selected=t||[],this._updateStyleState()},_.getConfig=function(t){t=parseInt(t,10);var e={multipleChoice:2===t,clozeChoice:10===t};return e},_._dataApiClickHandler=function(){var t=e(this).closest(d.CHOICE_CONTAINER)[0],n=t&&t.getAttribute(p.QUE_ID),a=_._getRootId(this);if(n&&a){var i=this.getAttribute(p.CHOICE_ITEM),o=this.parentElement,s=o&&o.getAttribute(p.CHOICE_GROUP);_._getInstance(n,a,t).updateSelectedState(i,s)}},_._getInstance=function(t,n,a){var i=e(a).data(r);if(!i){var o=a.getAttribute(p.LOGIC_TYPE),s=_.getConfig(o);i=new _(t,n,a,[],s),e(a).data(r,i)}return i},_._getRootId=function(t){var n=e(t).closest(d.ROOT_CONTAINER)[0],a=n&&n.getAttribute(p.ROOT_ID);return a},_._dataInitialHandler=function(){for(var n=e(d.CHOICE_CONTAINER).toArray(),a=n&&n.length||0,i=0;i<a;i++){var o=n[i],s=o.getAttribute(p.QUE_ID),r=s&&t.cache[s],l=_._getRootId(o);l&&r&&r.data&&_._getInstance(s,l,o).fillDataIntoComponent(r.data)}},Object.defineProperties(_,h),e(document).on(c.CLICK_DATA_API,d.CHOICE_ITEM,_._dataApiClickHandler),e(document).on(n.CHANGE,_._dataInitialHandler)}(jQuery),function(e){var o="blank",s="1.0.0",r="talqs.blank",l="."+r,u=".data-api",c={KEYUP_DATA_API:"blur"+l+u},d={QUE_ID:i.queId,BLANK_ITEM:i.blankItem,ROOT_ID:i.rootId},p={BLANK_ITEM:"["+i.blankItem+"]",BLANK_CONTAINER:"["+i.type+'="blank"]',ROOT_CONTAINER:"["+i.rootId+"]"},I=function(t,e,n,a){this._queId=t,this._rootId=e,this._element=n,this._blankData=a||[],this._num=0},_={VERSION:{}};_.VERSION.get=function(){return s},I.prototype.updateBlankValueByIndex=function(n,i){if(n=parseInt(n,10),!isNaN(n)){var s=this._blankData[n];if(s!==i){if(this._blankData[n]=i,!this._num){var r=e(this._element).find(p.BLANK_ITEM).toArray();this._num=r&&r.length}var l=this._blankData.some(function(t){return t}),u={queId:this._queId,rootId:this._rootId,data:l?this._blankData:null,type:o,blankNum:this._num};l?t.set(this._queId,u):t.remove(this._queId),a(u)}}},I.prototype.fillDataIntoComponent=function(t){var n=this;this._blankData=t;var a=e(this._element).find(p.BLANK_ITEM).toArray();a&&a.forEach(function(t,e){t.value=n._blankData[e]})},I._dataApiInputHandler=function(t){var n=e(this).closest(p.BLANK_CONTAINER)[0],a=n&&n.getAttribute(d.QUE_ID),i=I._getRootId(this);if(a&&i){var o=t.target.value.trim();t.target.value=o;var s=this.getAttribute(d.BLANK_ITEM);I._getInstance(a,i,n).updateBlankValueByIndex(s,o)}},I._getInstance=function(t,n,a){var i=e(a).data(r);return i||(i=new I(t,n,a,[]),e(a).data(r,i)),i},I._getRootId=function(t){var n=e(t).closest(p.ROOT_CONTAINER)[0],a=n&&n.getAttribute(d.ROOT_ID);return a},I._dataInitialHandler=function(){for(var n=e(p.BLANK_CONTAINER).toArray(),a=n&&n.length||0,i=0;i<a;i++){var o=n[i],s=o.getAttribute(d.QUE_ID),r=I._getRootId(o),l=s&&t.cache[s];r&&l&&l.data&&I._getInstance(s,r,o).fillDataIntoComponent(l.data)}},Object.defineProperties(I,_),e(document).on(c.KEYUP_DATA_API,p.BLANK_ITEM,I._dataApiInputHandler),e(document).on(n.CHANGE,I._dataInitialHandler)}(jQuery),function(e){var o="dropdown",s="1.0.0",r="talqs.dropdown",l="."+r,u=".data-api",c={CHANGE:"change"+l+u},d={DROPDOWN_ITEM:"["+i.inputid+"]",DROPDOWN_CONTAINER:"["+i.type+'="dropdown"]',ROOT_CONTAINER:"["+i.rootId+"]"},p={QUE_ID:i.queId,INPUTID:i.inputid,ROOT_ID:i.rootId},I=function(t,e,n,a){this._queId=t,this._element=n,this._selectData=a||[],this._rootId=e,this._blankNum=0},_={VERSION:{}};_.VERSION.get=function(){return s},I.prototype.updateBlankValueByIndex=function(n,i){var s=this;if(n=parseInt(n,10),!isNaN(n)){if(this._selectData[n]=i,!this._blankNum){var r=e(this._element).find(d.DROPDOWN_ITEM).toArray();this._blankNum=r&&r.length}for(var l=this._selectData.some(function(t){return t}),u=[],c=0;c<this._selectData.length;c++)u.push(s._selectData[c]||"");var p={rootId:this._rootId,queId:this._queId,data:l?u:null,type:o,blankNum:this._blankNum};l?t.set(this._queId,p):t.remove(this._queId),a(p)}},I.prototype.fillDataIntoComponent=function(t){var n=this;this._selectData=t;var a=e(this._element).find(d.DROPDOWN_ITEM).toArray();a&&a.forEach(function(t,e){t.value=n._selectData[e]})},I._dataApiSelectHandler=function(t){var n=e(this).closest(d.DROPDOWN_CONTAINER)[0],a=n&&n.getAttribute(p.QUE_ID),i=I._getRootId(this);if(a&&i){var o=t.target.value,s=this.getAttribute(p.INPUTID);I._getInstance(a,i,n).updateBlankValueByIndex(s,o)}},I._getInstance=function(t,n,a){var i=e(a).data(r);return i||(i=new I(t,n,a,[]),e(a).data(r,i)),i},I._getRootId=function(t){var n=e(t).closest(d.ROOT_CONTAINER)[0],a=n&&n.getAttribute(p.ROOT_ID);return a},I._dataInitialHandler=function(){for(var n=e(d.DROPDOWN_CONTAINER).toArray(),a=n&&n.length||0,i=0;i<a;i++){var o=n[i],s=o.getAttribute(p.QUE_ID),r=I._getRootId(o),l=s&&t.cache[s];r&&l&&l.data&&I._getInstance(s,r,o).fillDataIntoComponent(l.data)}},Object.defineProperties(I,_),e(document).on(c.CHANGE,d.DROPDOWN_ITEM,I._dataApiSelectHandler),e(document).on(n.CHANGE,I._dataInitialHandler)}(jQuery),"talqs"),s=o+"_options",r={content:o+"_content",main:o,options:s,optionsList:s+"_list",optionsRows:s+"_rows",optionsColumns:s+"_columns",optionsItem:s+"_columns_item",optionsIndex:s+"_index",optionsLabel:s+"_label",optionsContent:s+"_content",clear:"clearfix",input:o+"_blank_input",label:o+"_label",panel:o+"_panel"},l="data.logicQuesTypeId",u=l+" == 4",c=l+" == 10 || "+l+" == 3",d=l+" == 1 || "+l+" == 2",p='\n  {{if data.content && !data.hideContent}}\n    <div class="'+r.content+" "+r.clear+'" '+i.queId+'="{{data.queId}}"\n      {{if '+u+" }}\n        "+i.type+'="blank"\n      {{ else if '+c+" }}\n        "+i.type+'="dropdown"\n      {{/if}}\n    >\n        {{#data.content | transfromBlankContent:data}}\n      </div>\n  {{/if}}\n',I="\n{{ if data.answerOptionList && !data.isCloze && "+d+' }}\n    <div class="'+r.options+'" '+i.type+'="choice" '+i.queId+'="{{data.queId}}" '+i.logicType+'="{{'+l+'}}">\n        <ul class="'+r.optionsList+'" '+i.autoLayout+'="{{data.answerOptionList[0].length}}">\n          {{each data.answerOptionList}}\n            <li class="'+r.optionsRows+'">\n              <ul class="'+r.optionsColumns+"_{{$value.length}} "+r.clear+'" '+i.optionGroup+'="{{$index}}">\n                {{each $value}}\n                  <li class="'+r.optionsItem+" "+r.clear+'" '+i.optionItem+'="{{$value.aoVal}}">\n                    <span class="'+r.optionsLabel+'">{{$value.aoVal}}. </span>\n                    <div class="'+r.optionsContent+'">{{#$value.content}}</div>\n                  </li>\n                {{/each}}\n              </ul>\n            </li>\n          {{/each}}\n        </ul>\n    </div>\n{{/if}}',_='\n  <label class="'+r.label+'">\n    {{config.labels.myanswer}}\n  </label>\n  <div class="'+r.panel+'">\n     {{#(data.myanswer)}}\n  </div>\n',h={questionContent:p,questionOptions:I,questionMyAnswer:_},f=/(?:&nbsp;)*<(?:u|span\s[^>]+)>(?:&nbsp;|\s){3,}(\d*)(?:&nbsp;|\s){3,}<\/(?:u|span)>(?:&nbsp;)*/g,v=[3,4,10],O={};O.transfromBlankContent=function(t,e){var n=parseInt(e.logicQuesTypeId,10);if(v.indexOf(n)!==-1){var a,o,s=-1;3===n&&(a=e.answerOptionList.map(function(t){return t[0]})),t=t.replace(f,function(t){if(s++,4===n)o='<input type="text" '+i.blankItem+'="'+s+'" class="'+r.input+'">';else{a=3===n?a:e.answerOptionList[s];var l=a.map(function(t){return'<option value="'+t.aoVal+'">'+t.content+"</option>"});o="\n              <span>\n                <select "+i.inputid+'="'+s+'">\n                  <option value></option>\n                  '+l.join("")+"\n                </select>\n              </span>\n          "}return o})}return t};var C=function(t){var e=t.components;t.updateTemplateList((n={},n[e.StemsWrapper]={components:[{name:e.Content,template:h.questionContent},{name:e.Options,template:h.questionOptions}]},n[e.AnalyzeWrapper]={components:[{name:"questionMyAnswer",template:h.questionMyAnswer,index:1}]},n));var n;for(var a in O)t.registerHelper(a,O[a])},A=function(t){t?C(TalqsTemplate):TalqsTemplate.resetComponent()},m={setData:function(e){if(Array.isArray(e))e.forEach(function(e){t.set(e.queId,e)});else for(var a in e)t.set(a,e[a]);document.dispatchEvent(new Event(n.CHANGE))},getData:function(e){return t.get(e)},isInteractive:!0,toggleInteraction:function(t){this.isInteractive=void 0!==t?t:!this.isInteractive,A(this.isInteractive)},init:function(){this.toggleInteraction(this.isInteractive)},onChange:null,defaultConfig:{url:"http://paperrestfz.aibeike.com/paperrest/rest/question/verifyAnswer.json",dataType:"jsonp"},VALIDATE_ERR:1e3,submit:function(t){var e=t||{};if(e.answer){var n=e.success,a=e.error,i=function(t){return"function"==typeof t},o={success:function(t){t.success?i(n)&&n(t.data):i(a)&&a({message:t.message,status:this.VALIDATE_ERR})},error:function(t){i(a)&&a(t)}},s=Object.assign(this.defaultConfig,t,o);s.data&&(s.data.content=JSON.stringify(e.answer),$.ajax(s))}}};return m.init(),document.addEventListener(n.INPUT,function(t){var e=m.onChange;e&&e.call(this,t)}),m});